---
globs: "*.py"
---
# XCP-D Project Rules

## Project Identity

- Package: `xcp_d` -- fMRI postprocessing BIDS App
- Default branch: `main`
- Entry point: [xcp_d/cli/run.py](mdc:xcp_d/cli/run.py)

## Linting & Formatting

- Linter/formatter: ruff ~= 0.15.0
- Config: [pyproject.toml](mdc:pyproject.toml) under `[tool.ruff]`
- Pre-commit: [.pre-commit-config.yaml](mdc:.pre-commit-config.yaml) with ruff v0.6.2
- Black is disabled (`[tool.black] exclude = ".*"`)
- **Cleanest ignore list** of all four repos: only S105, S311, S603

## Version Management

- Uses `__about__.py` pattern: [xcp_d/__about__.py](mdc:xcp_d/__about__.py)
- Exports `__version__`, `__packagename__`, `__copyright__`, `__credits__`
- `_version.py` is auto-generated by hatch-vcs; `__about__.py` imports from it

## `fill_doc` Decorator

Use `@fill_doc` (from `xcp_d.utils.doc`) on workflow init functions to inject shared
parameter documentation. The decorator fills `%(parameter_name)s` placeholders in docstrings.

## Config Hashing

`config.hash_config()` creates unique identifiers for pipeline configurations.
Used to detect when outputs need regeneration due to parameter changes.
See `DEFAULT_CONFIG_HASH_FIELDS` in [xcp_d/config.py](mdc:xcp_d/config.py).

## Ingression Modules

`xcp_d/ingression/` adapts non-BIDS input formats:
- `abcdbids.py`: ABCD-BIDS format
- `hcpya.py`: HCP Young Adult format
- `ukbiobank.py`: UK Biobank format
When adding new input formats, create a module in this directory.

## Executive Summary Reports

HTML reports generated via Jinja2 templates in `xcp_d/data/executive_summary_templates/`.
Interface: `xcp_d/interfaces/execsummary.py`; utils: `xcp_d/utils/execsummary.py`.

## Key Module Paths

- BOLD workflows: `xcp_d/workflows/bold/` (cifti, nifti, concatenation)
- Anatomical workflows: `xcp_d/workflows/anatomical/` (surface, volume, parcellation)
- Parcellation: [xcp_d/workflows/parcellation.py](mdc:xcp_d/workflows/parcellation.py)
- Bundled atlases: `xcp_d/data/atlases/` (Glasser, Gordon, HCP, Tian, MIDB, MyersLabonte)
- Nuisance configs: `xcp_d/data/nuisance/` (YAML strategy files)
- Config: [xcp_d/config.py](mdc:xcp_d/config.py)

## Testing

- Test extras: `tests` in pyproject.toml
- Parallel test execution supported via `pytest-xdist`
- Integration test markers defined in `[tool.pytest.ini_options]`
- `mock_config` context manager in `xcp_d/tests/tests.py` for workflow unit tests
